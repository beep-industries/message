openapi: 3.1.0
info:
  title: Messaging Service
  version: 1.0.0
  description: API REST synchrone (pas de queue) pour lecture/édition/suppression, pin et recherche.
servers:
  - url: https://api.example.com
security:
  - bearerAuth: []
paths:
  /messages/{channel}/{id}:
    get:
      summary: Récupère un message précis
      parameters:
        - name: channel
          in: path
          required: true
          schema: { type: string }
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        "200":
          description: Message trouvé
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Message" }
        "404": { $ref: "#/components/responses/NotFound" }

  /messages/{channel}:
    get:
      summary: Liste des messages d’un canal (pagination backward)
      parameters:
        - name: channel
          in: path
          required: true
          schema: { type: string }
        - name: limit
          in: query
          required: false
          schema: { type: integer, minimum: 1, maximum: 200, default: 50 }
        - name: before
          in: query
          required: false
          description: message_id avant lequel paginer
          schema: { type: string, format: uuid }
      responses:
        "200":
          description: Page de messages
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: "#/components/schemas/Message" }
                  next_before:
                    type: string
                    format: uuid
                    nullable: true

  /messages/{id}:
    patch:
      summary: Modifier son message (contenu, notify, metadata)
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/MessageUpdate" }
      responses:
        "200":
          description: Message modifié
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Message" }
        "403": { $ref: "#/components/responses/Forbidden" }
        "404": { $ref: "#/components/responses/NotFound" }

    delete:
      summary: Supprimer un message (propre ou d’autrui si autorisé)
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        "204": { description: Supprimé }
        "403": { $ref: "#/components/responses/Forbidden" }
        "404": { $ref: "#/components/responses/NotFound" }

  /messages/pin/{id}:
    post:
      summary: Épingler un message (droits requis sur le canal)
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        "204": { description: Épinglé }
        "403": { $ref: "#/components/responses/Forbidden" }
        "404": { $ref: "#/components/responses/NotFound" }
        
  /messages/pin/{channel}:
    get:
      summary: Liste les messages épinglés d’un canal
      parameters:
        - name: channel
          in: path
          required: true
          schema: { type: string }
        - name: limit
          in: query
          required: false
          schema: { type: integer, minimum: 1, maximum: 200, default: 50 }
        - name: offset
          in: query
          required: false
          schema: { type: integer, minimum: 0, default: 0 }
      responses:
        "200":
          description: Page de messages épinglés
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: "#/components/schemas/Message" }
                  total:
                    type: integer

  /messages/search:
    get:
      summary: Recherche avancée dans les messages et documents
      parameters:
        - name: channel
          in: query
          required: true
          schema: { type: string }
        - name: q
          in: query
          required: true
          schema: { type: string, minLength: 1 }
        - name: limit
          in: query
          required: false
          schema: { type: integer, minimum: 1, maximum: 100, default: 25 }
        - name: offset
          in: query
          required: false
          schema: { type: integer, minimum: 0, default: 0 }
        - name: in_docs
          in: query
          required: false
          description: Inclure la recherche dans les documents attachés/partagés
          schema: { type: boolean, default: true }
      responses:
        "200":
          description: Résultats de recherche
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: "#/components/schemas/SearchResult" }
                  total: { type: integer }

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  responses:
    NotFound:
      description: Ressource introuvable
      content:
        application/json:
          schema: { $ref: "#/components/schemas/Error" }
    Forbidden:
      description: Droits insuffisants
      content:
        application/json:
          schema: { $ref: "#/components/schemas/Error" }
  schemas:
    Message:
      type: object
      required: [id, channel_id, author_id, content, created_at]
      properties:
        id: { type: string, format: uuid }
        channel_id: { type: string }
        author_id: { type: string }
        content: { type: string }
        markdown: { type: boolean, default: true }
        reply_to: { type: string, format: uuid, nullable: true }
        attachments:
          type: array
          items:
            type: object
            properties:
              id: { type: string, format: uuid }
              name: { type: string }
              url: { type: string, format: uri }
        notify:
          type: array
          items: { $ref: "#/components/schemas/NotifyEntry" }
        pinned: { type: boolean, default: false }
        created_at: { type: string, format: date-time }
        edited_at: { type: string, format: date-time, nullable: true }
        deleted_at: { type: string, format: date-time, nullable: true }

    MessageUpdate:
      type: object
      properties:
        content: { type: string }
        notify:
          type: array
          items: { $ref: "#/components/schemas/NotifyEntry" }
      additionalProperties: false

    NotifyEntry:
      type: object
      required: [type, id]
      properties:
        type:
          type: string
          enum: [role, member]
        id: { type: string }

    SearchResult:
      type: object
      required: [type, id, channel_id, snippet, score]
      properties:
        type:
          type: string
          enum: [message, document]
        id: { type: string }
        channel_id: { type: string }
        snippet: { type: string }
        score: { type: number }
        message_id: { type: string, format: uuid, nullable: true } # pour les résultats documentaires liés à un message
        metadata:
          type: object
          additionalProperties: true

    Error:
      type: object
      properties:
        error: { type: string }
        code: { type: string }